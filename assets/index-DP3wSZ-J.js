import{initializeApp as A}from"https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";import{getAuth as F,onAuthStateChanged as T,signInWithCustomToken as R,signInAnonymously as N}from"https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";import{getFirestore as L,setLogLevel as _,collection as M,query as B,onSnapshot as $}from"https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))r(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const s of o.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&r(s)}).observe(document,{childList:!0,subtree:!0});function n(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function r(i){if(i.ep)return;i.ep=!0;const o=n(i);fetch(i.href,o)}})();let f,u,O,d;async function D(e,t){try{f=A(e),u=F(f),O=L(f),_("debug"),T(u,U),await S()}catch(n){throw console.error("Error initializing Firebase:",n),new Error("Could not initialize Firebase authentication")}}async function U(e){if(e){d=e.uid,console.log("User is signed in with UID:",d);const t=document.getElementById("user-id-display");t&&(t.textContent=`User ID: ${d}`),window.dispatchEvent(new CustomEvent("userAuthenticated",{detail:{userId:d}}))}else console.log("User is signed out"),d=null,await S()}async function S(){try{typeof __initial_auth_token<"u"&&__initial_auth_token?(await R(u,__initial_auth_token),console.log("Signed in with custom token")):(await N(u),console.log("Signed in anonymously"))}catch(e){throw console.error("Error during sign-in:",e),new Error("Authentication failed")}}function b(){return d}const v={SEARCH_DEBOUNCE_MS:300,MESSAGE_TIMEOUT_MS:5e3};let a=[],p=null;async function q(){if(!b())throw new Error("User must be authenticated to initialize recipes");P(),z()}function P(){const e=L(),t=b(),n=M(e,`users/${t}/${COLLECTIONS.RECIPES}`),r=B(n);p&&p(),p=$(r,i=>{a=[],i.forEach(o=>{a.push({id:o.id,...o.data()})}),a.sort((o,s)=>o.itemName.localeCompare(s.itemName)),m()},i=>{console.error("Error loading recipes:",i),c("Failed to load recipes. Please check your connection.")})}function z(){window.addEventListener("searchFilterChanged",e=>{const{searchTerm:t,filterCategory:n}=e.detail;j(t,n)})}function j(e,t){const n=e?e.toLowerCase():"",r=a.filter(i=>{const o=!n||i.itemName&&i.itemName.toLowerCase().includes(n)||i.description&&i.description.toLowerCase().includes(n)||i.ingredients&&i.ingredients.some(l=>l.toLowerCase().includes(n))||i.instructions&&i.instructions.some(l=>l.toLowerCase().includes(n)),s=t==="All"||i.categories&&i.categories.includes(t);return o&&s});m(r)}function m(e=a){const t=document.getElementById("recipe-container");t&&(t.innerHTML=e.length===0?'<p class="text-center text-gray-500 col-span-full">No recipes found. Try adjusting your search or add a new recipe.</p>':"",e.forEach(n=>{const r=k(n);t.appendChild(r)}))}function k(e){const t=document.createElement("div");t.className="bg-white rounded-xl shadow-lg overflow-hidden recipe-card";const n=e.itemName||"Unnamed Recipe",r=e.categories||[],i=e.description||"No description provided.",o=e.ingredients||[],s=e.instructions||[],l=e.notes||"";return t.innerHTML=`
        <div class="p-6">
            <h3 class="text-2xl font-playfair text-amber-700 mb-3">${n}</h3>
            ${r.length>0?`<p class="text-xs text-amber-500 mb-2">Categories: ${r.join(", ")}</p>`:""}
            <p class="text-gray-600 text-sm mb-4">${i}</p>
            
            ${o.length>0?`
            <div class="mt-4">
                <h4 class="font-semibold text-amber-600">Ingredients:</h4>
                <ul class="list-disc list-inside text-gray-700 text-sm mt-2">
                    ${o.map(g=>`<li>${g}</li>`).join("")}
                </ul>
            </div>`:""}

            ${s.length>0?`
            <div class="mt-4">
                <h4 class="font-semibold text-amber-600">Instructions:</h4>
                <ol class="list-decimal list-inside text-gray-700 text-sm mt-2">
                    ${s.map(g=>`<li>${g}</li>`).join("")}
                </ol>
            </div>`:""}

            ${l?`
                <div class="mt-4">
                    <h4 class="font-semibold text-amber-600">Notes:</h4>
                    <p class="text-gray-600 italic text-sm mt-2">${l}</p>
                </div>
            `:""}

            <div class="mt-6 flex justify-end space-x-2">
                <button class="edit-recipe px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 text-sm"
                        data-recipe-id="${e.id}">Edit</button>
                <button class="delete-recipe px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 text-sm"
                        data-recipe-id="${e.id}">Delete</button>
            </div>
        </div>
    `,t.querySelector(".edit-recipe").addEventListener("click",()=>V(e.id)),t.querySelector(".delete-recipe").addEventListener("click",()=>H(e.id)),t}async function G(e){try{const t={...e,id:Date.now().toString(),createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};a.push(t),a.sort((n,r)=>(n.itemName||"").localeCompare(r.itemName||"")),saveRecipesToLocalStorage(),m(),w("Recipe added successfully!")}catch(t){console.error("Error adding recipe:",t),c("Failed to add recipe.")}}async function H(e){try{a=a.filter(t=>t.id!==e),saveRecipesToLocalStorage(),m(),w("Recipe deleted successfully!")}catch(t){console.error("Error deleting recipe:",t),c("Failed to delete recipe.")}}function V(e){const t=a.find(n=>n.id===e);c(t?"Edit modal functionality is not implemented.":"Recipe not found for editing.")}let h="",y="All";function K(){W(),J(),Q()}function W(){const e=document.getElementById("toggleManualInputButton"),t=document.getElementById("cancelButton"),n=document.getElementById("recipeForm");e&&e.addEventListener("click",()=>{console.log("Add New Recipe button clicked"),E()}),t&&t.addEventListener("click",()=>{E(),C()}),n&&n.addEventListener("submit",X)}function J(){const e=document.getElementById("searchInput"),t=document.getElementById("categoryFilter");if(e){let n;e.addEventListener("input",r=>{clearTimeout(n),n=setTimeout(()=>{h=r.target.value.toLowerCase(),window.dispatchEvent(new CustomEvent("searchFilterChanged",{detail:{searchTerm:h,filterCategory:y}}))},v.SEARCH_DEBOUNCE_MS)})}t&&t.addEventListener("change",n=>{y=n.target.value,window.dispatchEvent(new CustomEvent("searchFilterChanged",{detail:{searchTerm:h,filterCategory:y}}))})}function Q(){const e=document.getElementById("recipeForm");if(!e)return;e.querySelectorAll("input, textarea").forEach(n=>{n.addEventListener("input",()=>x(n))})}function x(e){const t=e.value;let n=!0,r="";e.required&&!t.trim()&&(n=!1,r="This field is required");const i=e.getAttribute("maxlength");i&&t.length>i&&(n=!1,r=`Maximum length is ${i} characters`),e.classList.toggle("border-red-500",!n);const o=e.parentElement.querySelector(".error-message");return o&&(o.textContent=r,o.classList.toggle("hidden",n)),n}async function X(e){e.preventDefault();const t=e.target,n=new FormData(t),r=Object.fromEntries(n.entries());let i=!0;if(t.querySelectorAll("input[required], textarea[required]").forEach(s=>{x(s)||(i=!1)}),!i){c("Please fill in all required fields correctly.");return}try{Y("Saving recipe..."),await G(r),w("Recipe added successfully!"),C(),E()}catch(s){console.error("Error saving recipe:",s),c("Failed to save recipe. Please try again.")}finally{Z()}}function E(){console.log("toggleManualInput function called");const e=document.getElementById("manualInputSection");e&&(console.log("manualInputSection found, current classes:",e.className),e.classList.toggle("hidden"),console.log("manualInputSection classes after toggle:",e.className))}function C(){const e=document.getElementById("recipeForm");e&&e.reset()}function c(e){const t=document.getElementById("error-message");t&&(t.textContent=e,t.classList.remove("hidden"),setTimeout(()=>t.classList.add("hidden"),v.MESSAGE_TIMEOUT_MS))}function w(e){const t=document.getElementById("success-message");t&&(t.textContent=e,t.classList.remove("hidden"),setTimeout(()=>t.classList.add("hidden"),v.MESSAGE_TIMEOUT_MS))}function Y(e="Loading..."){const t=document.getElementById("loading-overlay");t&&t.classList.remove("hidden")}function Z(){const e=document.getElementById("loading-overlay");e&&e.classList.add("hidden")}async function ee(){try{await D(),K(),await q(),console.log("Application initialized successfully")}catch(e){console.error("Failed to initialize app:",e),I("Failed to initialize the application. Please refresh the page.")}}window.onerror=function(e,t,n,r,i){return console.error("Global error:",{message:e,source:t,lineno:n,colno:r,error:i}),I("An unexpected error occurred. Please refresh the page."),!1};window.onunhandledrejection=function(e){console.error("Unhandled promise rejection:",e.reason),I("An unexpected error occurred. Please refresh the page.")};function I(e){const t=document.getElementById("error-message");t&&(t.textContent=e,t.classList.remove("hidden"),setTimeout(()=>t.classList.add("hidden"),5e3))}document.addEventListener("DOMContentLoaded",ee);
