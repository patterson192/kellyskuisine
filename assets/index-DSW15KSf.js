import{initializeApp as q}from"https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";import{getAuth as G,onAuthStateChanged as W,signInWithCustomToken as V,signInAnonymously as H}from"https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";import{getFirestore as E,setLogLevel as K,collection as D,serverTimestamp as A,addDoc as J,query as Q,onSnapshot as X,doc as P,deleteDoc as Y,setDoc as Z}from"https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";import{getAnalytics as ee}from"https://www.gstatic.com/firebasejs/10.8.0/firebase-analytics.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const a of o.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function n(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(i){if(i.ep)return;i.ep=!0;const o=n(i);fetch(i.href,o)}})();let u,C,te,ne,f;async function ie(t,e){try{if(console.log("Starting Firebase initialization..."),!t||typeof t!="object")throw new Error("Invalid Firebase configuration");const s=["apiKey","authDomain","projectId","storageBucket","messagingSenderId","appId"].filter(i=>!t[i]);if(s.length>0)throw new Error(`Missing required Firebase configuration fields: ${s.join(", ")}`);u=q(t),console.log("Firebase app initialized"),C=G(u),console.log("Firebase auth initialized"),te=E(u),console.log("Firestore initialized");try{ne=ee(u),console.log("Analytics initialized")}catch(i){console.warn("Analytics initialization failed:",i)}K("debug"),W(C,oe),await j(),console.log("Firebase initialization completed successfully")}catch(n){throw console.error("Error initializing Firebase:",n),new Error(`Firebase initialization failed: ${n.message}`)}}async function oe(t){try{if(t){f=t.uid,console.log("User is signed in with UID:",f);const e=document.getElementById("user-id-display");e&&(e.textContent=`User ID: ${f}`),window.dispatchEvent(new CustomEvent("userAuthenticated",{detail:{userId:f}}))}else console.log("User is signed out"),f=null,await j()}catch(e){throw console.error("Error in auth state change:",e),new Error(`Authentication state change failed: ${e.message}`)}}async function j(){try{typeof __initial_auth_token<"u"&&__initial_auth_token?(await V(C,__initial_auth_token),console.log("Signed in with custom token")):(await H(C),console.log("Signed in anonymously"))}catch(t){throw console.error("Error during sign-in:",t),new Error(`Authentication failed: ${t.message}`)}}function I(){return f}const se={apiKey:"AIzaSyAX1F4gzD0-nsAbj7yhSaJZxcwvWNRVFus",authDomain:"kelly-s-kuisine.firebaseapp.com",projectId:"kelly-s-kuisine",storageBucket:"kelly-s-kuisine.firebasestorage.app",messagingSenderId:"974729459966",appId:"1:974729459966:web:42bad27bd106242bfc0daf",measurementId:"G-CGY3C6F1Q2"},re="1:974729459966:web:42bad27bd106242bfc0daf",ce={RECIPES:"recipes"},z={SEARCH_DEBOUNCE_MS:300,MESSAGE_TIMEOUT_MS:5e3};let m=[],N=null;async function ae(){if(!I())throw new Error("User must be authenticated to initialize recipes");de(),le()}function de(){const t=E(u),e=I(),n=D(t,"users",e,ce.RECIPES),s=Q(n);N&&N(),N=X(s,i=>{console.log(`[Recipes] Snapshot received. Empty: ${i.empty}, Size: ${i.size}`),m=[],i.forEach(o=>{m.push({id:o.id,...o.data()})}),console.log("[Recipes] Processed recipes array:",m),m.sort((o,a)=>o.itemName.localeCompare(a.itemName)),$()},i=>{console.error("Error loading recipes:",i),l("Failed to load recipes. Please check your connection.")})}function le(){window.addEventListener("searchFilterChanged",t=>{const{searchTerm:e,filterCategory:n}=t.detail;ue(e,n)})}function ue(t,e){const n=t?t.toLowerCase():"",s=m.filter(i=>{const o=!n||i.itemName&&i.itemName.toLowerCase().includes(n)||i.description&&i.description.toLowerCase().includes(n)||i.ingredients&&i.ingredients.some(d=>d.toLowerCase().includes(n))||i.instructions&&i.instructions.some(d=>d.toLowerCase().includes(n)),a=e==="All"||i.categories&&i.categories.includes(e);return o&&a});$(s)}function $(t=m){console.log("[Recipes] Attempting to display recipes:",t);const e=document.getElementById("recipe-container");if(!e){console.error("[Recipes] Recipe container not found!");return}e.innerHTML=t.length===0?'<p class="text-center text-gray-500 col-span-full">No recipes found. Try adjusting your search or add a new recipe.</p>':"",t.forEach(n=>{const s=me(n);e.appendChild(s)})}function me(t){const e=document.createElement("div");e.className="bg-white rounded-xl shadow-lg overflow-hidden recipe-card flex flex-col justify-between";const n=document.createElement("div");n.className="p-6";const s=t.itemName||"Unnamed Recipe",i=t.categories||[],o=t.description||"",a=t.ingredients||[],d=t.instructions||[],r=t.notes||"",x=document.createElement("h3");if(x.className="text-2xl font-playfair text-amber-700 mb-3",x.textContent=s,n.appendChild(x),i.length>0){const c=document.createElement("p");c.className="text-xs text-amber-500 mb-2",c.textContent=`Categories: ${i.join(", ")}`,n.appendChild(c)}if(o){const c=document.createElement("p");c.className="text-gray-600 text-sm mb-4",c.textContent=o,n.appendChild(c)}const k=(c,p,g)=>{if(p.length===0)return;const w=document.createElement("div");w.className="mt-4";const L=document.createElement("h4");L.className="font-semibold text-amber-600",L.textContent=c,w.appendChild(L);const S=document.createElement(g?"ol":"ul");S.className=`${g?"list-decimal":"list-disc"} list-inside text-gray-700 text-sm mt-2`,p.forEach(O=>{const _=document.createElement("li");_.textContent=O,S.appendChild(_)}),w.appendChild(S),n.appendChild(w)};if(k("Ingredients:",a,!1),k("Instructions:",d,!0),r){const c=document.createElement("div");c.className="mt-4";const p=document.createElement("h4");p.className="font-semibold text-amber-600",p.textContent="Notes:",c.appendChild(p);const g=document.createElement("p");g.className="text-gray-600 italic text-sm mt-2",g.textContent=r,c.appendChild(g),n.appendChild(c)}e.appendChild(n);const v=document.createElement("div");v.className="p-6 pt-0 flex justify-end space-x-2";const h=document.createElement("button");h.className="edit-recipe px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 text-sm",h.textContent="Edit",h.dataset.recipeId=t.id,h.addEventListener("click",()=>he(t.id));const y=document.createElement("button");return y.className="delete-recipe px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 text-sm",y.textContent="Delete",y.dataset.recipeId=t.id,y.addEventListener("click",()=>fe(t.id)),v.appendChild(h),v.appendChild(y),e.appendChild(v),e}async function pe(t){try{const e=E(u),n=I();if(!n)throw new Error("User not authenticated for adding recipe.");const s=D(e,"users",n,"recipes"),i={...t,createdAt:A(),updatedAt:A()};await J(s,i),b("Recipe added successfully!")}catch(e){throw console.error("Error adding recipe to Firestore:",e),l("Failed to add recipe."),e}}async function ge(t,e){try{const n=E(u),s=I();if(!s)throw new Error("User not authenticated for updating recipe.");const i=P(n,"users",s,"recipes",t),o={...e,updatedAt:A()};await Z(i,o,{merge:!0}),b("Recipe updated successfully!")}catch(n){throw console.error("Error updating recipe in Firestore:",n),l("Failed to update recipe."),n}}async function fe(t){try{if(!confirm("Are you sure you want to delete this recipe?"))return;const e=E(u),n=I();if(!n)throw new Error("User not authenticated for deleting recipe.");const s=P(e,"users",n,"recipes",t);await Y(s),b("Recipe deleted successfully!")}catch(e){throw console.error("Error deleting recipe from Firestore:",e),l("Failed to delete recipe."),e}}function he(t){const e=m.find(n=>n.id===t);e?Le(e):l("Recipe not found for editing.")}let R="",F="All",B=null;function ye(){Ee(),Ie(),ve()}function Ee(){console.log("Attaching UI event listeners...");const t=document.getElementById("manualEntryBox"),e=document.getElementById("ocrEntryBox"),n=document.getElementById("addManualRecipeButton"),s=document.getElementById("cancelEditButton");t&&t.addEventListener("click",()=>{console.log("Manual entry box clicked!"),document.getElementById("manualInputSection").classList.remove("hidden"),document.getElementById("ocrInputSection").classList.add("hidden")}),e&&e.addEventListener("click",()=>{console.log("OCR entry box clicked!"),document.getElementById("ocrInputSection").classList.remove("hidden"),document.getElementById("manualInputSection").classList.add("hidden")}),n&&n.addEventListener("click",Be);const i=document.getElementById("addFileRecipeButton");i&&i.addEventListener("click",Ce);const o=document.getElementById("saveChangesButton");o&&o.addEventListener("click",Se),s&&s.addEventListener("click",()=>{document.getElementById("edit-recipe-modal").classList.add("hidden")})}function Ie(){const t=document.getElementById("searchInput"),e=document.getElementById("categoryFilter");if(t){let n;t.addEventListener("input",s=>{clearTimeout(n),n=setTimeout(()=>{R=s.target.value.toLowerCase(),window.dispatchEvent(new CustomEvent("searchFilterChanged",{detail:{searchTerm:R,filterCategory:F}}))},z.SEARCH_DEBOUNCE_MS)})}e&&e.addEventListener("change",n=>{F=n.target.value,window.dispatchEvent(new CustomEvent("searchFilterChanged",{detail:{searchTerm:R,filterCategory:F}}))})}function ve(){const t=document.getElementById("recipeForm");if(!t)return;t.querySelectorAll("input, textarea").forEach(n=>{n.addEventListener("input",()=>we(n))})}function we(t){const e=t.value;let n=!0,s="";t.required&&!e.trim()&&(n=!1,s="This field is required");const i=t.getAttribute("maxlength");i&&e.length>i&&(n=!1,s=`Maximum length is ${i} characters`),t.classList.toggle("border-red-500",!n);const o=t.parentElement.querySelector(".error-message");return o&&(o.textContent=s,o.classList.toggle("hidden",n)),n}async function Be(t){t.preventDefault();const e={itemName:document.getElementById("itemName").value,categories:document.getElementById("categories").value,description:document.getElementById("description").value,ingredients:document.getElementById("ingredients").value,instructions:document.getElementById("instructions").value,notes:""};if(e.categories=e.categories.split(",").map(n=>n.trim()).filter(Boolean),e.ingredients=e.ingredients.split(`
`).map(n=>n.trim()).filter(Boolean),e.instructions=e.instructions.split(`
`).map(n=>n.trim()).filter(Boolean),!e.itemName||e.ingredients.length===0||e.instructions.length===0){l("Recipe Name, Ingredients, and Instructions are required.");return}try{M("Saving recipe..."),await pe(e),document.getElementById("itemName").value="",document.getElementById("categories").value="",document.getElementById("description").value="",document.getElementById("ingredients").value="",document.getElementById("instructions").value="",document.getElementById("manualInputSection").classList.add("hidden")}catch(n){console.error("Error saving recipe:",n)}finally{U()}}async function Ce(){const t=document.getElementById("fileInput"),e=t.files[0];if(!e){l("Please select a file to upload.");return}M("Processing file, this may take a moment...");try{let n="";if(e.type==="text/plain")n=await e.text();else if(e.type.startsWith("image/")){const{data:i}=await Tesseract.recognize(e,"eng",{logger:o=>console.log(`[OCR] ${o.status}: ${Math.round(o.progress*100)}%`)});n=i.text}else throw new Error("Unsupported file type. Please use .txt, .jpg, or .png.");const s=be(n);xe(s),document.getElementById("manualInputSection").classList.remove("hidden"),document.getElementById("ocrInputSection").classList.add("hidden"),b("Recipe data extracted! Please review and save.")}catch(n){console.error("Error processing file:",n),l(n.message||"Failed to process file.")}finally{U(),t.value=""}}function be(t){const e=t.split(`
`).map(o=>o.trim()).filter(Boolean);if(e.length===0)return{};const n={itemName:e.shift()||"Untitled Recipe",notes:"",ingredients:[],instructions:[]};let s="notes";const i={ingredients:["ingredients"],instructions:["instructions","directions","method","preparation"],nutrition:["nutrition facts","nutrition information","per serving"]};for(const o of e){const a=o.toLowerCase();let d=!1;if(i.instructions.some(r=>a.startsWith(r))?(s="instructions",d=!0):i.ingredients.some(r=>a.startsWith(r))?(s="ingredients",d=!0):i.nutrition.some(r=>a.startsWith(r))&&(s="nutrition",d=!0),!d)if(s==="notes")n.notes+=o+`
`;else if(s==="ingredients")if(o.endsWith(":"))n.ingredients.push(""),n.ingredients.push(`--- ${o.slice(0,-1)} ---`);else{const r=o.replace(/^[-•*–—]\s*/,"").trim();r&&n.ingredients.push(r)}else if(s==="instructions"){const r=o.replace(/^\d+[.)]?\s*|^step\s*\d+[:\s]*/i,"").trim();r&&n.instructions.push(r)}else s==="nutrition"?(n.notes+=(n.notes?`

`:"")+`Nutrition Facts:
`+o,s="nutrition-body"):s==="nutrition-body"&&(n.notes+=`
`+o)}return n.notes=n.notes.trim(),n}function xe(t){document.getElementById("itemName").value=t.itemName||"",document.getElementById("ingredients").value=(t.ingredients||[]).join(`
`),document.getElementById("instructions").value=(t.instructions||[]).join(`
`),document.getElementById("description").value=t.notes||"",document.getElementById("categories").value=""}function l(t){const e=document.getElementById("error-message");e&&(e.textContent=t,e.classList.remove("hidden"),setTimeout(()=>e.classList.add("hidden"),z.MESSAGE_TIMEOUT_MS))}function b(t){const e=document.getElementById("success-message");e&&(e.textContent=t,e.classList.remove("hidden"),setTimeout(()=>e.classList.add("hidden"),z.MESSAGE_TIMEOUT_MS))}function M(t="Loading..."){const e=document.getElementById("loading-overlay");e&&e.classList.remove("hidden")}function U(){const t=document.getElementById("loading-overlay");t&&t.classList.add("hidden")}function Le(t){const e=document.getElementById("edit-recipe-modal");e&&(document.getElementById("editItemName").value=t.itemName||"",document.getElementById("editCategories").value=(t.categories||[]).join(", "),document.getElementById("editDescription").value=t.description||"",document.getElementById("editIngredients").value=(t.ingredients||[]).join(`
`),document.getElementById("editInstructions").value=(t.instructions||[]).join(`
`),document.getElementById("editNotes").value=t.notes||"",B=t.id,e.classList.remove("hidden"),setTimeout(()=>{e.scrollIntoView({behavior:"smooth",block:"center"})},100),document.getElementById("editItemName").focus())}async function Se(){if(!B){l("No recipe selected for editing.");return}const t={itemName:document.getElementById("editItemName").value,categories:document.getElementById("editCategories").value.split(",").map(e=>e.trim()).filter(Boolean),description:document.getElementById("editDescription").value,ingredients:document.getElementById("editIngredients").value.split(`
`).map(e=>e.trim()).filter(Boolean),instructions:document.getElementById("editInstructions").value.split(`
`).map(e=>e.trim()).filter(Boolean),notes:document.getElementById("editNotes").value};if(!t.itemName||t.ingredients.length===0||t.instructions.length===0){l("Recipe Name, Ingredients, and Instructions are required.");return}try{M("Updating recipe..."),await ge(B,t),document.getElementById("edit-recipe-modal").classList.add("hidden"),B=null}catch(e){console.error("Error updating recipe:",e)}finally{U()}}async function Ne(){try{console.log("Starting application initialization..."),console.log("Initializing Firebase authentication..."),await ie(se,re),console.log("Firebase authentication initialized successfully"),console.log("Initializing UI components..."),ye(),console.log("UI components initialized successfully"),console.log("Initializing recipes..."),await ae(),console.log("Recipes initialized successfully"),console.log("Application initialized successfully")}catch(t){console.error("Failed to initialize app:",t);const e=t.message||"Unknown error occurred";T(`Failed to initialize the application: ${e}. Please refresh the page.`)}}window.onerror=function(t,e,n,s,i){console.error("Global error:",{message:t,source:e,lineno:n,colno:s,error:i});const o=i?i.message:t;return T(`An unexpected error occurred: ${o}. Please refresh the page.`),!1};window.onunhandledrejection=function(t){console.error("Unhandled promise rejection:",t.reason);const e=t.reason?t.reason.message:"Unknown error";T(`An unexpected error occurred: ${e}. Please refresh the page.`)};function T(t){const e=document.getElementById("error-message");e?(e.textContent=t,e.classList.remove("hidden"),setTimeout(()=>e.classList.add("hidden"),5e3)):console.error("Error message element not found:",t)}document.addEventListener("DOMContentLoaded",Ne);
