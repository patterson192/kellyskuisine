<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kelly's Kuisine - Your Recipe Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/tesseract.js@4.0.0/dist/tesseract.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, setDoc, deleteDoc, onSnapshot, collection, query, serverTimestamp, updateDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
        apiKey: "AIzaSyAX1F4gzD0-nsAbj7yhSaJZxcwvWNRVFus",
        authDomain: "kelly-s-kuisine.firebaseapp.com",
        projectId: "kelly-s-kuisine",
        storageBucket: "kelly-s-kuisine.firebasestorage.app",
        messagingSenderId: "974729459966",
        appId: "1:974729459966:web:42bad27bd106242bfc0daf",
        measurementId: "G-CGY3C6F1Q2"
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-recipe-app';

        // --- Initialize Firebase ---
        let app;
        let db;
        let auth;
        let userId;
        let recipesCollectionRef;
        let unsubscribeRecipes = () => {}; // Function to unsubscribe from Firestore listener

        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            setLogLevel('debug');
        } catch (error) {
            console.error("Error initializing Firebase:", error);
            displayGlobalError("Could not connect to the database. Please try again later.");
        }

        // --- Global State ---
        let recipes = [];
        let recipeToEditId = null; // To store the ID of the recipe being edited
        let currentSearchTerm = '';
        let currentFilterCategory = 'All';

        // --- UI Elements ---
        const recipeContainer = document.getElementById('recipe-container');
        const itemNameInput = document.getElementById('itemName');
        const descriptionInput = document.getElementById('description');
        const ingredientsInput = document.getElementById('ingredients');
        const instructionsInput = document.getElementById('instructions');
        const categoriesInput = document.getElementById('categories'); // New
        const fileInput = document.getElementById('fileInput');
        const errorMessageElement = document.getElementById('error-message');
        const successMessageElement = document.getElementById('success-message');
        const loadingOverlay = document.getElementById('loading-overlay');
        const userIdDisplay = document.getElementById('user-id-display');

        // Confirmation Modal Elements
        const confirmationModal = document.getElementById('confirmation-modal');
        const confirmDeleteButton = document.getElementById('confirm-delete-button');
        const cancelDeleteButton = document.getElementById('cancel-delete-button');
        let recipeToDeleteId = null;

        // Edit Modal Elements (expanded)
        const editRecipeModal = document.getElementById('edit-recipe-modal');
        const editItemNameInput = document.getElementById('editItemName');
        const editDescriptionInput = document.getElementById('editDescription');
        const editIngredientsInput = document.getElementById('editIngredients');
        const editInstructionsInput = document.getElementById('editInstructions');
        const editCategoriesInput = document.getElementById('editCategories'); // New
        const editPrepTimeInput = document.getElementById('editPrepTime'); // New
        const editCookTimeInput = document.getElementById('editCookTime'); // New
        const editTotalTimeInput = document.getElementById('editTotalTime'); // New
        const editRestingTimeInput = document.getElementById('editRestingTime'); // New
        const editAdditionalTimeInput = document.getElementById('editAdditionalTime'); // New
        const editServingsInput = document.getElementById('editServings'); // New
        const editYieldInput = document.getElementById('editYield'); // New
        const editNotesInput = document.getElementById('editNotes'); // New
        const saveChangesButton = document.getElementById('saveChangesButton');
        const cancelEditButton = document.getElementById('cancelEditButton');

        // Search and Filter Elements
        const searchInput = document.getElementById('searchInput');
        const categoryFilterSelect = document.getElementById('categoryFilter');
        const allCategories = new Set(); // To store unique categories for the filter dropdown

        // Manual Recipe Input Toggle
        const toggleManualInputButton = document.getElementById('toggleManualInputButton');
        const manualInputSection = document.getElementById('manualInputSection');

        // Add modal for full-screen recipe view
        let fullRecipeModal = document.createElement('div');
        fullRecipeModal.id = 'full-recipe-modal';
        fullRecipeModal.className = 'hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-[100]';
        fullRecipeModal.innerHTML = `
            <div class="bg-white rounded-xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto p-8 relative">
                <button id="closeFullRecipeModal" class="absolute top-4 right-4 text-2xl text-gray-500 hover:text-gray-800">&times;</button>
                <div id="full-recipe-content"></div>
            </div>
        `;
        document.body.appendChild(fullRecipeModal);
        const fullRecipeContent = fullRecipeModal.querySelector('#full-recipe-content');
        const closeFullRecipeModalBtn = fullRecipeModal.querySelector('#closeFullRecipeModal');
        closeFullRecipeModalBtn.addEventListener('click', () => {
            fullRecipeModal.classList.add('hidden');
        });
        fullRecipeModal.addEventListener('click', (e) => {
            if (e.target === fullRecipeModal) fullRecipeModal.classList.add('hidden');
        });

        // Function to render a recipe in the modal
        function showFullRecipeModal(recipe) {
            let html = `<h2 class="text-3xl font-playfair text-amber-700 mb-4">${recipe.itemName}</h2>`;
            if (recipe.categories && recipe.categories.length > 0) {
                html += `<p class="text-xs text-amber-500 mb-2">Categories: ${recipe.categories.join(', ')}</p>`;
            }
            html += `<p class="text-gray-600 text-base mb-4">${recipe.description || 'No description provided.'}</p>`;
            html += `<div class="grid grid-cols-2 gap-2 text-xs text-gray-500 mb-4">`;
            if (recipe.prepTime) html += `<div><strong>Prep:</strong> ${recipe.prepTime}</div>`;
            if (recipe.cookTime) html += `<div><strong>Cook:</strong> ${recipe.cookTime}</div>`;
            if (recipe.totalTime) html += `<div><strong>Total:</strong> ${recipe.totalTime}</div>`;
            if (recipe.restingTime) html += `<div><strong>Rest:</strong> ${recipe.restingTime}</div>`;
            if (recipe.additionalTime) html += `<div><strong>Additional:</strong> ${recipe.additionalTime}</div>`;
            if (recipe.servings) html += `<div><strong>Servings:</strong> ${recipe.servings}</div>`;
            if (recipe.yield) html += `<div><strong>Yield:</strong> ${recipe.yield}</div>`;
            html += `</div>`;
            if (recipe.ingredients && recipe.ingredients.length > 0 && recipe.ingredients[0].items && recipe.ingredients[0].items.length > 0) {
                html += '<h4 class="text-lg font-semibold text-amber-600 mt-4 mb-2">Ingredients</h4><ul class="list-disc list-inside text-gray-700 space-y-1 text-base">';
                recipe.ingredients.forEach(component => {
                    if (component.items && component.items.length > 0) {
                        html += `<li class="font-medium">${component.component}</li><ul class="list-disc list-inside ml-4 space-y-0.5">`;
                        component.items.forEach(item => {
                            html += `<li>${item.quantity ? item.quantity + ' ' : ''}${item.item}</li>`;
                        });
                        html += '</ul>';
                    }
                });
                html += '</ul>';
            }
            if (recipe.instructions && recipe.instructions.length > 0) {
                html += '<h4 class="text-lg font-semibold text-amber-600 mt-4 mb-2">Directions</h4><ol class="list-decimal list-inside text-gray-700 space-y-2 text-base">';
                recipe.instructions.forEach(step => {
                    html += `<li class="break-words"><strong>Step ${step.step}:</strong> ${step.description}</li>`;
                });
                html += '</ol>';
            }
            if (recipe.notes && recipe.notes.length > 0) {
                html += '<h4 class="text-lg font-semibold text-amber-600 mt-4 mb-2">Notes</h4><ul class="list-disc list-inside text-gray-600 italic space-y-1 text-base">';
                recipe.notes.forEach(note => {
                    html += `<li class="break-words">${note}</li>`;
                });
                html += '</ul>';
            }
            fullRecipeContent.innerHTML = html;
            fullRecipeModal.classList.remove('hidden');
        }

        // --- Authentication ---
        async function initializeAuth() {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    console.log("User is signed in with UID:", userId);
                    if (userIdDisplay) userIdDisplay.textContent = `User ID: ${userId}`;
                    recipesCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/recipes`);
                    loadRecipes();
                } else {
                    console.log("User is signed out. Attempting to sign in...");
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                            console.log("Signed in with custom token.");
                        } else {
                            await signInAnonymously(auth);
                            console.log("Signed in anonymously.");
                        }
                    } catch (error) {
                        console.error("Error during sign-in:", error);
                        displayGlobalError("Authentication failed. Please refresh the page.");
                    }
                }
            });
        }


        // --- Recipe Display ---
        function displayRecipes() {
            if (!recipeContainer) return;

            // Collect all unique categories
            allCategories.clear();
            recipes.forEach(recipe => {
                if (recipe.categories && Array.isArray(recipe.categories)) {
                    recipe.categories.forEach(cat => allCategories.add(cat.trim()));
                }
            });
            populateCategoryFilter(); // Update filter dropdown

            const filteredRecipes = recipes.filter(recipe => {
                const matchesSearch = currentSearchTerm === '' ||
                    recipe.itemName.toLowerCase().includes(currentSearchTerm.toLowerCase()) ||
                    (recipe.description && recipe.description.toLowerCase().includes(currentSearchTerm.toLowerCase())) ||
                    (recipe.ingredients && recipe.ingredients[0] && recipe.ingredients[0].items.some(ing => ing.item.toLowerCase().includes(currentSearchTerm.toLowerCase()))) ||
                    (recipe.instructions && recipe.instructions.some(inst => inst.description.toLowerCase().includes(currentSearchTerm.toLowerCase())));

                const matchesCategory = currentFilterCategory === 'All' ||
                                        (recipe.categories && recipe.categories.some(cat => cat.toLowerCase() === currentFilterCategory.toLowerCase()));

                return matchesSearch && matchesCategory;
            });


            recipeContainer.innerHTML = filteredRecipes.length === 0 ?
                '<p class="text-center text-gray-500 col-span-full">No recipes match your criteria. Try adjusting your search or filters.</p>' : '';

            filteredRecipes.forEach((recipe) => {
                const recipeCard = document.createElement('div');
                recipeCard.className = 'bg-white rounded-xl shadow-lg overflow-hidden transform hover:scale-105 transition-transform duration-300 ease-in-out cursor-pointer';
                recipeCard.id = `recipe-${recipe.id}`;

                let html = `
                    <div class="p-6">
                        <h3 class="text-2xl font-playfair text-amber-700 mb-3">${recipe.itemName}</h3>
                        ${recipe.categories && recipe.categories.length > 0 ? `<p class="text-xs text-amber-500 mb-2">Categories: ${recipe.categories.join(', ')}</p>` : ''}
                        <p class="text-gray-600 text-sm mb-4 break-words">${recipe.description || 'No description provided.'}</p>

                        <div class="grid grid-cols-2 gap-2 text-xs text-gray-500 mb-4">
                            ${recipe.prepTime ? `<div><strong>Prep:</strong> ${recipe.prepTime}</div>` : ''}
                            ${recipe.cookTime ? `<div><strong>Cook:</strong> ${recipe.cookTime}</div>` : ''}
                            ${recipe.totalTime ? `<div><strong>Total:</strong> ${recipe.totalTime}</div>` : ''}
                            ${recipe.restingTime ? `<div><strong>Rest:</strong> ${recipe.restingTime}</div>` : ''}
                            ${recipe.additionalTime ? `<div><strong>Additional:</strong> ${recipe.additionalTime}</div>` : ''}
                            ${recipe.servings ? `<div><strong>Servings:</strong> ${recipe.servings}</div>` : ''}
                            ${recipe.yield ? `<div><strong>Yield:</strong> ${recipe.yield}</div>` : ''}
                        </div>`;

                if (recipe.ingredients && recipe.ingredients.length > 0 && recipe.ingredients[0].items && recipe.ingredients[0].items.length > 0) {
                    html += '<h4 class="text-lg font-semibold text-amber-600 mt-4 mb-2">Ingredients</h4><ul class="list-disc list-inside text-gray-700 space-y-1 text-sm">';
                    recipe.ingredients.forEach(component => {
                        if (component.items && component.items.length > 0) {
                            html += `<li class="font-medium">${component.component}</li><ul class="list-disc list-inside ml-4 space-y-0.5">`;
                            component.items.forEach(item => {
                                html += `<li>${item.quantity ? item.quantity + ' ' : ''}${item.item}</li>`;
                            });
                            html += '</ul>';
                        }
                    });
                    html += '</ul>';
                }


                if (recipe.instructions && recipe.instructions.length > 0) {
                    html += '<h4 class="text-lg font-semibold text-amber-600 mt-4 mb-2">Directions</h4><ol class="list-decimal list-inside text-gray-700 space-y-2 text-sm">';
                    recipe.instructions.forEach(step => {
                        html += `<li class="break-words"><strong>Step ${step.step}:</strong> ${step.description}</li>`;
                    });
                    html += '</ol>';
                }

                if (recipe.notes && recipe.notes.length > 0) {
                    html += '<h4 class="text-lg font-semibold text-amber-600 mt-4 mb-2">Notes</h4><ul class="list-disc list-inside text-gray-600 italic space-y-1 text-sm">';
                    recipe.notes.forEach(note => {
                        html += `<li class="break-words">${note}</li>`;
                    });
                    html += '</ul>';
                }

                html += `
                        <div class="mt-6 flex justify-end space-x-2">
                            <button data-id="${recipe.id}" class="edit-recipe-button bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-3 rounded-lg shadow-md hover:shadow-lg transition-all duration-150 ease-in-out text-xs">
                                Edit
                            </button>
                            <button data-id="${recipe.id}" data-name="${recipe.itemName}" class="delete-recipe-button bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-3 rounded-lg shadow-md hover:shadow-lg transition-all duration-150 ease-in-out text-xs">
                                Delete
                            </button>
                        </div>
                    </div>`;
                recipeCard.innerHTML = html;
                recipeCard.addEventListener('click', function(e) {
                    // Prevent click on edit/delete buttons from opening modal
                    if (e.target.closest('.edit-recipe-button') || e.target.closest('.delete-recipe-button')) return;
                    showFullRecipeModal(recipe);
                });
                recipeContainer.appendChild(recipeCard);
            });

            // Add event listeners to new buttons
            document.querySelectorAll('.delete-recipe-button').forEach(button => {
                button.addEventListener('click', function() {
                    recipeToDeleteId = this.dataset.id;
                    const recipeName = this.dataset.name || "this recipe";
                    showConfirmationModal(`Are you sure you want to delete "${recipeName}"?`);
                });
            });
            document.querySelectorAll('.edit-recipe-button').forEach(button => {
                button.addEventListener('click', function() {
                    openEditModal(this.dataset.id);
                });
            });
        }

        function populateCategoryFilter() {
            // Clear existing options except "All"
            categoryFilterSelect.innerHTML = '<option value="All">All Categories</option>';
            const sortedCategories = Array.from(allCategories).sort((a, b) => a.localeCompare(b));
            sortedCategories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                if (category === currentFilterCategory) {
                    option.selected = true;
                }
                categoryFilterSelect.appendChild(option);
            });
        }

        // --- Firestore Operations ---
        async function loadRecipes() {
            if (!recipesCollectionRef) {
                console.log("Recipe collection reference not ready.");
                return;
            }
            showLoading("Loading recipes...");
            if (typeof unsubscribeRecipes === 'function') unsubscribeRecipes();

            const q = query(recipesCollectionRef);
            unsubscribeRecipes = onSnapshot(q, (querySnapshot) => {
                recipes = [];
                querySnapshot.forEach((doc) => {
                    recipes.push({ id: doc.id, ...doc.data() });
                });
                recipes.sort((a, b) => a.itemName.localeCompare(b.itemName));
                displayRecipes(); // Now calls displayRecipes which handles filtering
                hideLoading();
            }, (error) => {
                console.error("Error loading recipes: ", error);
                displayErrorMessage("Failed to load recipes. Please check your connection.");
                hideLoading();
            });
        }

        async function addRecipeToFirestore(recipeData) {
            if (!recipesCollectionRef) {
                displayErrorMessage("Database not ready. Please try again.");
                return;
            }
            showLoading("Adding recipe...");
            try {
                await addDoc(recipesCollectionRef, {
                    ...recipeData,
                    createdAt: serverTimestamp()
                });
                displaySuccessMessage("Recipe added successfully!");
                clearInputFields();
            } catch (error) {
                console.error("Error adding recipe: ", error);
                displayErrorMessage("Failed to add recipe. Please try again.");
            } finally {
                hideLoading();
            }
        }

        async function updateRecipeInFirestore(docId, updatedData) {
            if (!recipesCollectionRef) {
                displayErrorMessage("Database not ready. Please try again.");
                return;
            }
            showLoading("Updating recipe...");
            try {
                const recipeRef = doc(recipesCollectionRef, docId);
                await setDoc(recipeRef, { // Using setDoc to overwrite, ensure all fields are present in updatedData
                    ...updatedData,
                    updatedAt: serverTimestamp() // Add/update an 'updatedAt' timestamp
                });
                displaySuccessMessage("Recipe updated successfully!");
                closeEditModal();
            } catch (error) {
                console.error("Error updating recipe: ", error);
                displayErrorMessage("Failed to update recipe. Please try again.");
            } finally {
                hideLoading();
            }
        }


        async function deleteRecipeFromFirestore(docId) {
            if (!recipesCollectionRef) {
                displayErrorMessage("Database not ready. Please try again.");
                return;
            }
            showLoading("Deleting recipe...");
            try {
                await deleteDoc(doc(recipesCollectionRef, docId));
                displaySuccessMessage("Recipe deleted successfully!");
            } catch (error) {
                console.error("Error deleting recipe: ", error);
                displayErrorMessage("Failed to delete recipe. Please try again.");
            } finally {
                hideLoading();
                recipeToDeleteId = null;
            }
        }

        // --- Recipe Parsing Logic (shared for add and edit) ---
        function parseFormToRecipeData(name, descriptionText, ingredientsText, instructionsText, categoriesText, prepTime, cookTime, totalTime, restingTime, additionalTime, servings, yieldText, notesText) {
            const recipe = { itemName: name.trim() }; // Ensure name is trimmed
            if (descriptionText && descriptionText.trim()) recipe.description = descriptionText.trim();

            // Categories
            if (categoriesText && categoriesText.trim()) {
                recipe.categories = categoriesText.split(',').map(cat => cat.trim()).filter(cat => cat !== '');
            } else {
                recipe.categories = [];
            }

            // Ingredients
            if (ingredientsText && ingredientsText.trim()) {
                const ingredientLines = ingredientsText.split('\n').filter(line => line.trim());
                recipe.ingredients = [{
                    component: "Main", // Assuming a single component for simplicity
                    items: ingredientLines.map(line => {
                        const trimmedLine = line.trim();
                        // Regex to capture quantity (including fractions, decimals, ranges) and units, then the item name
                        const quantityMatch = trimmedLine.match(/^([\d\/\.\s-]+(?:cups?|tablespoons?|teaspoons?|tsp|tbsp|oz|g|ml|kg|lbs?|pounds?|cloves?|pinch(?:es)?|dash(?:es)?)?)\s*(.*)/i);
                        if (quantityMatch && quantityMatch[2]) { // Ensure there's an item part
                            return { quantity: quantityMatch[1].trim().replace(/\s+/g, ' '), item: quantityMatch[2].trim() };
                        }
                        return { quantity: '', item: trimmedLine }; // Fallback if no clear quantity/item split
                    })
                }];
            } else {
                recipe.ingredients = [{ component: "Main", items: [] }]; // Ensure structure exists
            }

            // Instructions
            if (instructionsText && instructionsText.trim()) {
                const instructionLines = instructionsText.split('\n').filter(line => line.trim());
                recipe.instructions = instructionLines.map((line, index) => ({
                    step: index + 1,
                    description: line.trim()
                }));
            } else {
                recipe.instructions = [];
            }

            // Time fields
            if (prepTime && prepTime.trim()) recipe.prepTime = prepTime.trim();
            if (cookTime && cookTime.trim()) recipe.cookTime = cookTime.trim();
            if (totalTime && totalTime.trim()) recipe.totalTime = totalTime.trim();
            if (restingTime && restingTime.trim()) recipe.restingTime = restingTime.trim();
            if (additionalTime && additionalTime.trim()) recipe.additionalTime = additionalTime.trim();

            // Servings and Yield
            if (servings && servings.trim()) recipe.servings = servings.trim();
            if (yieldText && yieldText.trim()) recipe.yield = yieldText.trim();

            // Notes
            if (notesText && notesText.trim()) {
                recipe.notes = notesText.split('\n').map(note => note.trim()).filter(note => note !== '');
            } else {
                recipe.notes = [];
            }

            return recipe;
        }

        // Fix common OCR mistakes for fractions
        function fixOcrFractions(text) {
            // Map of patterns to replacements
            const fractionMap = {
                '1 2': '1/2',
                '1 3': '1/3',
                '3 4': '3/4',
                '2 3': '2/3',
                '1 4': '1/4',
                '1 8': '1/8',
                '3 8': '3/8',
                '5 8': '5/8',
                '7 8': '7/8'
            };
            // Replace Unicode fractions and %
            text = text
                .replace(/%/g, '1/2')
                .replace(/¼/g, '1/4')
                .replace(/¾/g, '3/4')
                .replace(/⅓/g, '1/3')
                .replace(/⅔/g, '2/3')
                .replace(/⅛/g, '1/8')
                .replace(/⅜/g, '3/8')
                .replace(/⅝/g, '5/8')
                .replace(/⅞/g, '7/8');
            // Normalize multiple spaces
            text = text.replace(/ +/g, ' ');
            // Log OCR text before replacement
            console.log('OCR before fraction fix:', text);
            // More robust regex for space-separated fractions
            text = text.replace(/(^|[\s.,;:!?\(\)\[\]{}"'])(1 2|1 3|3 4|2 3|1 4|1 8|3 8|5 8|7 8)(?=\s|[.,;:!?\(\)\[\]{}"']|$)/g, function(match, p1, p2) {
                return p1 + fractionMap[p2];
            });
            // Log OCR text after replacement
            console.log('OCR after fraction fix:', text);
            return text;
        }

        function parseNarrativeText(text, fileName) {
            const recipe = { itemName: fileName.replace(/\.[^/.]+$/, "") };
            const lines = text.split('\n').filter(line => line.trim());
            let currentSection = 'description';
            let description = [];
            let ingredients = [];
            let instructions = [];
            let currentInstruction = null;
            let notes = [];
            let categories = []; // New

            const timeRegex = /(Prep Time|Cook Time|Total Time|Resting Time|Additional Time):\s*([\d\s\w.,'-]+(?:minutes|hours|mins|hr|h|m)?)/im;
            const servingsRegex = /(Servings|Serves|Makes):\s*([\d\s\w.,'-]+)/im;
            const yieldRegex = /Yield:\s*([\d\s\w.,'-]+)/im;
            const stepRegex = /^(?:step\s*(\d+)|(\d+)\.)/i;
            const categoriesRegex = /(Categories):\s*([a-zA-Z,\s]+)/im; // Basic category detection

            lines.forEach(line => {
                const trimmedLine = line.trim();
                if (!trimmedLine) return;

                const timeMatch = trimmedLine.match(timeRegex);
                const servingsMatch = trimmedLine.match(servingsRegex);
                const yieldMatch = trimmedLine.match(yieldRegex);
                const categoriesMatch = trimmedLine.match(categoriesRegex); // New

                if (trimmedLine.match(/^(Ingredients|What You'll Need)/i)) currentSection = 'ingredients';
                else if (trimmedLine.match(/^(Directions|Instructions|Method|Preparation|How to Make It)/i)) {
                    currentSection = 'instructions';
                    if (currentInstruction) instructions.push(currentInstruction);
                    currentInstruction = null;
                } else if (trimmedLine.match(/^(Notes|Tips|From the Editor|Chef's Notes)/i)) currentSection = 'notes';
                else if (timeMatch) recipe[timeMatch[1].toLowerCase().replace(/\s+/g, '')] = timeMatch[2].trim();
                else if (servingsMatch) recipe.servings = servingsMatch[2].replace(/servings?/i, '').trim();
                else if (yieldMatch) recipe.yield = yieldMatch[1].replace(/servings?/i, '').trim();
                else if (categoriesMatch) categories = categoriesMatch[2].split(',').map(cat => cat.trim()).filter(cat => cat !== ''); // New
                else {
                    switch (currentSection) {
                        case 'ingredients': ingredients.push(trimmedLine); break;
                        case 'instructions':
                            const stepMatch = trimmedLine.match(stepRegex);
                            if (stepMatch) {
                                if (currentInstruction) instructions.push(currentInstruction);
                                currentInstruction = { step: parseInt(stepMatch[1] || stepMatch[2], 10), description: trimmedLine.replace(stepRegex, '').trim() };
                            } else if (currentInstruction) currentInstruction.description += ' ' + trimmedLine;
                            else currentInstruction = { step: instructions.length + 1, description: trimmedLine };
                            break;
                        case 'notes': notes.push(trimmedLine); break;
                        case 'description': default: description.push(trimmedLine); break;
                    }
                }
            });

            if (currentInstruction) instructions.push(currentInstruction);

            if (description.length > 0) recipe.description = description.join(' ').replace(/[^\w\s.,:;!?()'%&\\/-]/g, ' ').replace(/\s+/g, ' ').trim();
            if (ingredients.length > 0) {
                recipe.ingredients = [{
                    component: "Main",
                    items: ingredients.map(line => {
                        const quantityMatch = line.match(/^([\d\/\.\s-]+(?:cups?|tablespoons?|teaspoons?|tsp|tbsp|oz|g|ml|kg|lbs?|pounds?|cloves?|pinch(?:es)?|dash(?:es)?)?)\s*(.*)/i);
                        if (quantityMatch && quantityMatch[2]) return { quantity: quantityMatch[1].trim().replace(/\s+/g, ' ').replace(/11\/2/g, '1 ½'), item: quantityMatch[2].trim() };
                        return { quantity: '', item: line.trim() };
                    })
                }];
            } else {
                 recipe.ingredients = [{ component: "Main", items: [] }];
            }
            if (instructions.length > 0) {
                 recipe.instructions = instructions.filter(inst => inst.description.trim() !== "").map(instruction => ({
                    step: instruction.step,
                    description: instruction.description.replace(/[^\w\s.,:;!?()'%&\\/-]/g, ' ').replace(/\s+/g, ' ').trim()
                }));
            } else {
                recipe.instructions = [];
            }
            if (notes.length > 0) recipe.notes = notes.map(note => note.replace(/[^\w\s.,:;!?()'%&\\/-]/g, ' ').replace(/\s+/g, ' ').trim());
            else recipe.notes = [];

            if (categories.length > 0) recipe.categories = categories; // New
            else recipe.categories = [];

            return recipe;
        }

        // --- Event Handlers ---
        function handleAddManualRecipe() {
            const itemName = itemNameInput.value.trim();
            if (!itemName) {
                displayErrorMessage('Recipe name is required.');
                return;
            }
            hideMessages();
            const recipeData = parseFormToRecipeData(
                itemName,
                descriptionInput.value,
                ingredientsInput.value,
                instructionsInput.value,
                categoriesInput.value, // New
                null, // prepTime (not in manual add form for now)
                null, // cookTime
                null, // totalTime
                null, // restingTime
                null, // additionalTime
                null, // servings
                null, // yieldText
                null  // notesText
            );
            addRecipeToFirestore(recipeData);
        }

        async function handleAddFileRecipe() {
            const file = fileInput.files[0];
            if (!file) {
                displayErrorMessage('Please select a file.');
                return;
            }
            hideMessages();
            showLoading("Processing file...");
            const fileName = file.name;
            const reader = new FileReader();

            reader.onload = async function(event) {
                let parsedRecipe;
                try {
                    if (file.type === 'text/plain') {
                        // Apply OCR fix to text files as well, just in case
                        const fixedText = fixOcrFractions(event.target.result);
                        parsedRecipe = parseNarrativeText(fixedText, fileName);
                    } else if (file.type === 'image/jpeg' || file.type === 'image/png') {
                        showLoading("Recognizing text from image..."); // More specific
                        const { data: { text } } = await Tesseract.recognize(event.target.result, 'eng', { logger: m => console.log(m) });
                        showLoading("Parsing recognized text..."); // More specific
                        const fixedText = fixOcrFractions(text);
                        parsedRecipe = parseNarrativeText(fixedText, fileName);
                    } else {
                        displayErrorMessage('Unsupported file type. Please use JPG, PNG, or TXT.');
                        hideLoading(); return;
                    }
                    if (!parsedRecipe.itemName) parsedRecipe.itemName = fileName.replace(/\.[^/.]+$/, "") || "Untitled Recipe";
                    await addRecipeToFirestore(parsedRecipe);
                } catch (err) {
                    console.error("Error processing file:", err);
                    displayErrorMessage(`Error processing file: ${err.message}. Try a clearer image or enter manually.`);
                } finally {
                    hideLoading();
                    fileInput.value = '';
                }
            };
            reader.onerror = () => { displayErrorMessage('Failed to read the file.'); hideLoading(); };
            if (file.type === 'text/plain') reader.readAsText(file);
            else if (file.type === 'image/jpeg' || file.type === 'image/png') reader.readAsDataURL(file);
        }

        function handleSaveChanges() {
            const updatedItemName = editItemNameInput.value.trim();
            if (!updatedItemName) {
                displayErrorMessage("Recipe name cannot be empty in the edit form.");
                return;
            }
            hideMessages();

            const originalRecipe = recipes.find(r => r.id === recipeToEditId);
            if (!originalRecipe) {
                displayErrorMessage("Could not find the original recipe to update.");
                closeEditModal();
                return;
            }

            const formRecipeData = parseFormToRecipeData(
                updatedItemName,
                editDescriptionInput.value,
                editIngredientsInput.value,
                editInstructionsInput.value,
                editCategoriesInput.value, // New
                editPrepTimeInput.value,   // New
                editCookTimeInput.value,   // New
                editTotalTimeInput.value,  // New
                editRestingTimeInput.value,// New
                editAdditionalTimeInput.value, // New
                editServingsInput.value,   // New
                editYieldInput.value,      // New
                editNotesInput.value       // New
            );

            const updatedRecipeData = {
                ...originalRecipe,
                ...formRecipeData
            };
            if (originalRecipe.createdAt) {
                updatedRecipeData.createdAt = originalRecipe.createdAt;
            }

            updateRecipeInFirestore(recipeToEditId, updatedRecipeData);
        }

        // --- UI Helper Functions ---
        function clearInputFields() {
            if (itemNameInput) itemNameInput.value = '';
            if (descriptionInput) descriptionInput.value = '';
            if (ingredientsInput) ingredientsInput.value = '';
            if (instructionsInput) instructionsInput.value = '';
            if (categoriesInput) categoriesInput.value = ''; // Clear new field
            if (fileInput) fileInput.value = '';
        }

        function displayErrorMessage(message) {
            if (!errorMessageElement) return;
            errorMessageElement.textContent = message;
            errorMessageElement.classList.remove('hidden');
            successMessageElement.classList.add('hidden');
        }

        function displaySuccessMessage(message) {
            if (!successMessageElement) return;
            successMessageElement.textContent = message;
            successMessageElement.classList.remove('hidden');
            errorMessageElement.classList.add('hidden');
        }

        function displayGlobalError(message) {
            const globalErrorDiv = document.getElementById('global-error-message');
            if (globalErrorDiv) {
                globalErrorDiv.textContent = message;
                globalErrorDiv.classList.remove('hidden');
            }
        }

        function hideMessages() {
            if (errorMessageElement) errorMessageElement.classList.add('hidden');
            if (successMessageElement) successMessageElement.classList.add('hidden');
        }

        function showLoading(message = "Loading...") {
            if (!loadingOverlay) return;
            const loadingMessage = loadingOverlay.querySelector('p');
            if (loadingMessage) loadingMessage.textContent = message;
            loadingOverlay.classList.remove('hidden');
            loadingOverlay.classList.add('flex');
        }

        function hideLoading() {
            if (!loadingOverlay) return;
            loadingOverlay.classList.add('hidden');
            loadingOverlay.classList.remove('flex');
        }

        // --- Modal Controls ---
        function showConfirmationModal(message) {
            if (!confirmationModal) return;
            const modalMessage = confirmationModal.querySelector('#modal-message');
            if (modalMessage) modalMessage.textContent = message;
            confirmationModal.classList.remove('hidden');
            confirmationModal.classList.add('flex');
        }

        function hideConfirmationModal() {
            if (!confirmationModal) return;
            confirmationModal.classList.add('hidden');
            confirmationModal.classList.remove('flex');
        }

        function openEditModal(docId) {
            const recipe = recipes.find(r => r.id === docId);
            if (!recipe) {
                displayErrorMessage("Could not find recipe to edit.");
                return;
            }
            recipeToEditId = docId;

            editItemNameInput.value = recipe.itemName || '';
            editDescriptionInput.value = recipe.description || '';

            let ingredientsStr = '';
            if (recipe.ingredients && recipe.ingredients.length > 0 && recipe.ingredients[0].items) {
                ingredientsStr = recipe.ingredients[0].items.map(item => `${item.quantity || ''} ${item.item}`.trim()).join('\n');
            }
            editIngredientsInput.value = ingredientsStr;

            let instructionsStr = '';
            if (recipe.instructions && recipe.instructions.length > 0) {
                instructionsStr = recipe.instructions.map(step => step.description).join('\n');
            }
            editInstructionsInput.value = instructionsStr;

            // Populate new fields
            editCategoriesInput.value = recipe.categories ? recipe.categories.join(', ') : '';
            editPrepTimeInput.value = recipe.prepTime || '';
            editCookTimeInput.value = recipe.cookTime || '';
            editTotalTimeInput.value = recipe.totalTime || '';
            editRestingTimeInput.value = recipe.restingTime || '';
            editAdditionalTimeInput.value = recipe.additionalTime || '';
            editServingsInput.value = recipe.servings || '';
            editYieldInput.value = recipe.yield || '';
            editNotesInput.value = recipe.notes ? recipe.notes.join('\n') : '';

            editRecipeModal.classList.remove('hidden');
            editRecipeModal.classList.add('flex');
        }

        function closeEditModal() {
            if (!editRecipeModal) return;
            editRecipeModal.classList.add('hidden');
            editRecipeModal.classList.remove('flex');
            recipeToEditId = null;
            // Clear edit form fields
            editItemNameInput.value = '';
            editDescriptionInput.value = '';
            editIngredientsInput.value = '';
            editInstructionsInput.value = '';
            editCategoriesInput.value = '';
            editPrepTimeInput.value = '';
            editCookTimeInput.value = '';
            editTotalTimeInput.value = '';
            editRestingTimeInput.value = '';
            editAdditionalTimeInput.value = '';
            editServingsInput.value = '';
            editYieldInput.value = '';
            editNotesInput.value = '';
        }

        // --- Event Listeners Setup ---
        document.addEventListener('DOMContentLoaded', () => {
            if (auth) {
                initializeAuth();
            } else {
                console.error("Firebase auth is not initialized.");
                displayGlobalError("Application cannot start. Firebase authentication failed to initialize.");
                return;
            }

            const addManualRecipeButton = document.getElementById('addManualRecipeButton');
            const addFileRecipeButton = document.getElementById('addFileRecipeButton');

            if (addManualRecipeButton) addManualRecipeButton.addEventListener('click', handleAddManualRecipe);
            if (addFileRecipeButton) addFileRecipeButton.addEventListener('click', handleAddFileRecipe);

            if (confirmDeleteButton) {
                confirmDeleteButton.addEventListener('click', () => {
                    if (recipeToDeleteId) deleteRecipeFromFirestore(recipeToDeleteId);
                    hideConfirmationModal();
                });
            }
            if (cancelDeleteButton) {
                cancelDeleteButton.addEventListener('click', () => {
                    recipeToDeleteId = null;
                    hideConfirmationModal();
                });
            }
            // Edit Modal Listeners
            if (saveChangesButton) saveChangesButton.addEventListener('click', handleSaveChanges);
            if (cancelEditButton) cancelEditButton.addEventListener('click', closeEditModal);

            // Search & Filter Listeners
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    currentSearchTerm = e.target.value.trim();
                    displayRecipes(); // Re-render with new filter
                });
            }
            if (categoryFilterSelect) {
                categoryFilterSelect.addEventListener('change', (e) => {
                    currentFilterCategory = e.target.value;
                    displayRecipes(); // Re-render with new filter
                });
            }

            // Toggle Manual Input Listener
            if (toggleManualInputButton && manualInputSection) {
                toggleManualInputButton.addEventListener('click', () => {
                    manualInputSection.classList.toggle('hidden');
                    const isHidden = manualInputSection.classList.contains('hidden');
                    toggleManualInputButton.textContent = isHidden ? 'Show Manual Recipe Input' : 'Hide Manual Recipe Input';
                });
                // Initially hide the section
                manualInputSection.classList.add('hidden');
                toggleManualInputButton.textContent = 'Show Manual Recipe Input';
            }

            // Show/hide manual/OCR input forms on box click
            const manualEntryBox = document.getElementById('manualEntryBox');
            const ocrEntryBox = document.getElementById('ocrEntryBox');
            const manualInputSection = document.getElementById('manualInputSection');
            const ocrInputSection = document.getElementById('ocrInputSection');
            manualEntryBox.addEventListener('click', () => {
                manualInputSection.classList.remove('hidden');
                ocrInputSection.classList.add('hidden');
            });
            ocrEntryBox.addEventListener('click', () => {
                ocrInputSection.classList.remove('hidden');
                manualInputSection.classList.add('hidden');
            });
        });

    </script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #FFF8F0; }
        h1, h2, h3, h4, h5, h6 { font-family: 'Playfair Display', serif; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #FFF8F0; }
        ::-webkit-scrollbar-thumb { background: #EADDCA; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #D4C8B8; }
        .input-section textarea, .input-section input[type="text"],
        #edit-recipe-modal textarea, #edit-recipe-modal input[type="text"],
        #edit-recipe-modal input[type="text"], #edit-recipe-modal input[type="number"],
        #manualInputSection textarea, #manualInputSection input[type="text"] {
            border-color: #EADDCA;
            transition: border-color 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
        }
        .input-section textarea:focus, .input-section input[type="text"]:focus,
        #edit-recipe-modal textarea:focus, #edit-recipe-modal input[type="text"]:focus,
        #edit-recipe-modal input[type="number"]:focus,
        #manualInputSection textarea:focus, #manualInputSection input[type="text"]:focus {
            border-color: #B99A7B;
            box-shadow: 0 0 0 3px rgba(185, 154, 123, 0.2);
        }
        #loading-overlay p { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-amber-50 text-amber-900">

    <div id="global-error-message" class="hidden bg-red-600 text-white p-4 text-center fixed top-0 left-0 right-0 z-[60]"></div>
    <div id="loading-overlay" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 items-center justify-center z-[70]">
        <div class="flex flex-col items-center">
            <svg class="animate-spin h-10 w-10 text-white mb-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="text-white text-lg">Loading...</p>
        </div>
    </div>

    <div id="confirmation-modal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 items-center justify-center z-[60] p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
            <h4 class="text-lg font-semibold text-amber-700 mb-4">Confirm Action</h4>
            <p id="modal-message" class="text-gray-600 mb-6">Are you sure?</p>
            <div class="flex justify-end space-x-3">
                <button id="cancel-delete-button" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition-colors">Cancel</button>
                <button id="confirm-delete-button" class="px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 transition-colors">Confirm Delete</button>
            </div>
        </div>
    </div>

    <div id="edit-recipe-modal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 items-center justify-center z-50 p-4">
        <div class="bg-white p-6 md:p-8 rounded-xl shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <h3 class="text-2xl font-playfair text-amber-700 mb-6">Edit Recipe</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
                <div class="md:col-span-2">
                    <label for="editItemName" class="block text-sm font-medium text-amber-800 mb-1">Recipe Name <span class="text-red-500">*</span></label>
                    <input type="text" id="editItemName" class="w-full p-3 border border-amber-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500">
                </div>
                 <div class="md:col-span-2">
                    <label for="editCategories" class="block text-sm font-medium text-amber-800 mb-1">Categories (comma-separated)</label>
                    <input type="text" id="editCategories" placeholder="e.g., Dinner, Italian, Pasta" class="w-full p-3 border border-amber-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500">
                </div>
                <div class="md:col-span-2">
                    <label for="editDescription" class="block text-sm font-medium text-amber-800 mb-1">Description</label>
                    <textarea id="editDescription" rows="3" class="w-full p-3 border border-amber-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500"></textarea>
                </div>

                <div>
                    <label for="editPrepTime" class="block text-sm font-medium text-amber-800 mb-1">Prep Time</label>
                    <input type="text" id="editPrepTime" placeholder="e.g., 20 mins" class="w-full p-3 border border-amber-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500">
                </div>
                <div>
                    <label for="editCookTime" class="block text-sm font-medium text-amber-800 mb-1">Cook Time</label>
                    <input type="text" id="editCookTime" placeholder="e.g., 45 mins" class="w-full p-3 border border-amber-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500">
                </div>
                 <div>
                    <label for="editTotalTime" class="block text-sm font-medium text-amber-800 mb-1">Total Time</label>
                    <input type="text" id="editTotalTime" placeholder="e.g., 1 hr 5 mins" class="w-full p-3 border border-amber-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500">
                </div>
                <div>
                    <label for="editRestingTime" class="block text-sm font-medium text-amber-800 mb-1">Resting Time</label>
                    <input type="text" id="editRestingTime" placeholder="e.g., 30 mins" class="w-full p-3 border border-amber-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500">
                </div>
                <div>
                    <label for="editAdditionalTime" class="block text-sm font-medium text-amber-800 mb-1">Additional Time</label>
                    <input type="text" id="editAdditionalTime" placeholder="e.g., 2 hrs chilling" class="w-full p-3 border border-amber-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500">
                </div>
                <div>
                    <label for="editServings" class="block text-sm font-medium text-amber-800 mb-1">Servings</label>
                    <input type="text" id="editServings" placeholder="e.g., 4" class="w-full p-3 border border-amber-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500">
                </div>
                <div>
                    <label for="editYield" class="block text-sm font-medium text-amber-800 mb-1">Yield</label>
                    <input type="text" id="editYield" placeholder="e.g., 1 loaf" class="w-full p-3 border border-amber-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500">
                </div>

                <div class="md:col-span-2">
                    <label for="editIngredients" class="block text-sm font-medium text-amber-800 mb-1">Ingredients (one per line)</label>
                    <textarea id="editIngredients" rows="5" class="w-full p-3 border border-amber-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500"></textarea>
                </div>
                <div class="md:col-span-2">
                    <label for="editInstructions" class="block text-sm font-medium text-amber-800 mb-1">Instructions (one step per line)</label>
                    <textarea id="editInstructions" rows="5" class="w-full p-3 border border-amber-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500"></textarea>
                </div>
                <div class="md:col-span-2">
                    <label for="editNotes" class="block text-sm font-medium text-amber-800 mb-1">Notes (one per line)</label>
                    <textarea id="editNotes" rows="3" class="w-full p-3 border border-amber-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500"></textarea>
                </div>
            </div>
            <div class="mt-8 flex justify-end space-x-3">
                <button id="cancelEditButton" class="px-6 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition-colors">Cancel</button>
                <button id="saveChangesButton" class="px-6 py-2 bg-amber-600 hover:bg-amber-700 text-white font-semibold rounded-lg shadow-md hover:shadow-lg transition-all">Save Changes</button>
            </div>
        </div>
    </div>


    <div class="container mx-auto p-4 md:p-8 max-w-5xl">
        <header class="text-center mb-10 md:mb-16">
            <h1 class="text-5xl md:text-6xl font-playfair text-amber-700">Kelly's Kuisine</h1>
            <p class="text-amber-600 text-lg mt-2">Your Personal Recipe Collection</p>
            <p id="user-id-display" class="text-xs text-amber-500 mt-1"></p>
        </header>

        <div id="error-message" class="hidden bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-6 rounded-md shadow" role="alert"></div>
        <div id="success-message" class="hidden bg-green-100 border-l-4 border-green-500 text-green-700 p-4 mb-6 rounded-md shadow" role="alert"></div>

        <div class="mb-8 flex flex-col sm:flex-row gap-4 justify-center">
            <input type="text" id="searchInput" placeholder="Search recipes..." class="w-full sm:w-1/2 p-3 border border-amber-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition-shadow">
            <select id="categoryFilter" class="w-full sm:w-1/4 p-3 border border-amber-300 rounded-lg bg-white focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition-shadow">
                <option value="All">All Categories</option>
            </select>
        </div>

        <div class="input-section bg-white p-6 md:p-8 rounded-xl shadow-xl mb-12">
            <h2 class="text-3xl font-playfair text-amber-700 mb-6 border-b-2 border-amber-200 pb-3">Add a New Recipe</h2>
            <div class="flex flex-col md:flex-row gap-8 justify-center items-stretch">
                <div id="manualEntryBox" class="flex-1 flex flex-col items-center justify-center bg-amber-100 hover:bg-amber-200 border-2 border-amber-300 rounded-xl shadow-md cursor-pointer p-8 transition-colors duration-200 mb-4 md:mb-0">
                    <span class="text-4xl mb-2">✍️</span>
                    <span class="text-xl font-semibold text-amber-700 mb-1">Manual Entry</span>
                    <span class="text-sm text-amber-600">Type in your recipe details</span>
                </div>
                <div id="ocrEntryBox" class="flex-1 flex flex-col items-center justify-center bg-teal-100 hover:bg-teal-200 border-2 border-teal-300 rounded-xl shadow-md cursor-pointer p-8 transition-colors duration-200">
                    <span class="text-4xl mb-2">📷</span>
                    <span class="text-xl font-semibold text-teal-700 mb-1">OCR Entry</span>
                    <span class="text-sm text-teal-600">Upload a text file or image</span>
                </div>
            </div>
            <div id="manualInputSection" class="hidden mt-8">
                <h3 class="text-xl font-semibold text-amber-600 mb-3 border-b border-amber-200 pb-2">Enter Manually</h3>
                <div class="space-y-4">
                    <div>
                        <label for="itemName" class="block text-sm font-medium text-amber-800 mb-1">Recipe Name <span class="text-red-500">*</span></label>
                        <input type="text" id="itemName" placeholder="e.g., Classic Lasagna" class="w-full p-3 border border-amber-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition-shadow">
                    </div>
                    <div>
                        <label for="categories" class="block text-sm font-medium text-amber-800 mb-1">Categories (comma-separated)</label>
                        <input type="text" id="categories" placeholder="e.g., Dinner, Italian, Pasta" class="w-full p-3 border border-amber-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition-shadow">
                    </div>
                    <div>
                        <label for="description" class="block text-sm font-medium text-amber-800 mb-1">Description</label>
                        <textarea id="description" placeholder="A brief summary of your dish" rows="3" class="w-full p-3 border border-amber-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition-shadow"></textarea>
                    </div>
                    <div>
                        <label for="ingredients" class="block text-sm font-medium text-amber-800 mb-1">Ingredients (one per line)</label>
                        <textarea id="ingredients" placeholder="e.g., 500g Ground Beef&#10;1 Onion, chopped" rows="5" class="w-full p-3 border border-amber-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition-shadow"></textarea>
                    </div>
                    <div>
                        <label for="instructions" class="block text-sm font-medium text-amber-800 mb-1">Instructions (one step per line)</label>
                        <textarea id="instructions" placeholder="e.g., Brown the beef.&#10;Add onions and cook until soft." rows="5" class="w-full p-3 border border-amber-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition-shadow"></textarea>
                    </div>
                    <button id="addManualRecipeButton" class="w-full bg-amber-600 hover:bg-amber-700 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:shadow-lg transition-all duration-200 ease-in-out">
                        Add Manual Recipe
                    </button>
                </div>
            </div>
            <div id="ocrInputSection" class="hidden mt-8">
                <h3 class="text-xl font-semibold text-teal-700 mb-3 border-b border-amber-200 pb-2">Upload from File (OCR)</h3>
                <div class="space-y-4 bg-amber-50 p-6 rounded-lg border border-amber-200">
                    <p class="text-sm text-amber-700">Upload a recipe from a <strong class="font-medium">.txt</strong> file or an image (<strong class="font-medium">.jpg, .png</strong>).</p>
                    <div>
                        <label for="fileInput" class="block text-sm font-medium text-amber-800 mb-1">Select File</label>
                        <input type="file" id="fileInput" accept=".jpg,.jpeg,.png,.txt" class="w-full text-sm text-amber-700 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-amber-100 file:text-amber-700 hover:file:bg-amber-200 transition-colors">
                    </div>
                    <button id="addFileRecipeButton" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:shadow-lg transition-all duration-200 ease-in-out">
                        Add from File
                    </button>
                    <p class="text-xs text-amber-600 italic">Image OCR can take a moment. Please be patient.</p>
                </div>
            </div>
        </div>

        <h2 class="text-3xl md:text-4xl font-playfair text-amber-700 mb-8 text-center border-b-2 border-amber-200 pb-4">My Recipes</h2>

        <div id="recipe-container" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6 md:gap-8">
            </div>
    </div>

    <footer class="text-center py-8 mt-12 border-t border-amber-200">
        <p class="text-amber-600 text-sm">&copy; 2024 Kelly's Kuisine. Happy Cooking!</p>
    </footer>

</body>
</html>